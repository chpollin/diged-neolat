<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edition-5 Final Validation</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            font-size: 36px;
            margin-bottom: 40px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .status-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .status-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .status-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        .status-title {
            font-weight: bold;
            color: #34495e;
            margin-bottom: 5px;
        }
        .status-value {
            font-size: 24px;
            font-weight: bold;
        }
        .success { color: #27ae60; }
        .warning { color: #f39c12; }
        .error { color: #e74c3c; }
        .info { color: #3498db; }
        
        .test-section {
            margin: 40px 0;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
        }
        .test-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
        }
        .test-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .test-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-icon {
            width: 30px;
            font-size: 20px;
        }
        .test-name {
            flex: 1;
            margin-left: 15px;
        }
        .test-result {
            font-weight: bold;
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 40px 0;
        }
        button {
            padding: 15px 40px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        .btn-secondary {
            background: #ecf0f1;
            color: #2c3e50;
        }
        .btn-secondary:hover {
            background: #bdc3c7;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #ecf0f1;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #3498db);
            border-radius: 15px;
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .log-output {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-line {
            margin: 2px 0;
        }
        .log-success { color: #2ecc71; }
        .log-error { color: #e74c3c; }
        .log-warning { color: #f39c12; }
        .log-info { color: #3498db; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Edition-5 Final Validation Suite</h1>
        
        <div class="progress-bar">
            <div id="progressBar" class="progress-fill" style="width: 0%">0%</div>
        </div>
        
        <div class="status-grid">
            <div class="status-card">
                <div class="status-icon">üìö</div>
                <div class="status-title">Poems Loaded</div>
                <div id="poemCount" class="status-value info">0</div>
            </div>
            <div class="status-card">
                <div class="status-icon">üë•</div>
                <div class="status-title">Persons</div>
                <div id="personCount" class="status-value info">0</div>
            </div>
            <div class="status-card">
                <div class="status-icon">üìç</div>
                <div class="status-title">Places</div>
                <div id="placeCount" class="status-value info">0</div>
            </div>
            <div class="status-card">
                <div class="status-icon">üìù</div>
                <div class="status-title">Notes</div>
                <div id="noteCount" class="status-value info">0</div>
            </div>
            <div class="status-card">
                <div class="status-icon">üåê</div>
                <div class="status-title">Translations</div>
                <div id="translationCount" class="status-value info">0</div>
            </div>
            <div class="status-card">
                <div class="status-icon">‚úÖ</div>
                <div class="status-title">Success Rate</div>
                <div id="successRate" class="status-value info">0%</div>
            </div>
        </div>
        
        <div class="action-buttons">
            <button class="btn-primary" onclick="runFullValidation()">Run Full Validation</button>
            <button class="btn-secondary" onclick="testExport()">Test Export</button>
            <button class="btn-secondary" onclick="clearLog()">Clear Log</button>
        </div>
        
        <div class="test-section">
            <h2>üîç Module Status</h2>
            <div id="moduleTests"></div>
        </div>
        
        <div class="test-section">
            <h2>üìä Feature Tests</h2>
            <div id="featureTests"></div>
        </div>
        
        <div class="test-section">
            <h2>üéØ Export Test Results</h2>
            <div id="exportTests"></div>
        </div>
        
        <div class="log-output">
            <div id="logOutput"></div>
        </div>
    </div>
    
    <!-- Load the actual edition -->
    <iframe id="editionFrame" src="index.html" style="display: none;"></iframe>
    
    <script>
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0
        };
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const className = `log-${type}`;
            logDiv.innerHTML += `<div class="log-line ${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateProgress() {
            const progress = testResults.total > 0 ? 
                Math.round((testResults.passed / testResults.total) * 100) : 0;
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = progress + '%';
            progressBar.textContent = progress + '%';
            
            document.getElementById('successRate').textContent = progress + '%';
            document.getElementById('successRate').className = 
                `status-value ${progress >= 80 ? 'success' : progress >= 60 ? 'warning' : 'error'}`;
        }
        
        function clearLog() {
            document.getElementById('logOutput').innerHTML = '';
            testResults = { total: 0, passed: 0, failed: 0 };
            updateProgress();
        }
        
        async function runFullValidation() {
            clearLog();
            log('üöÄ Starting Full Validation Suite', 'info');
            
            // Get reference to edition window
            const edition = document.getElementById('editionFrame').contentWindow;
            
            // Wait for edition to load
            await new Promise(resolve => {
                if (edition.document.readyState === 'complete') {
                    resolve();
                } else {
                    edition.addEventListener('load', resolve);
                }
            });
            
            log('‚úÖ Edition frame loaded', 'success');
            
            // Test 1: Check global variables
            log('üìã Testing Global Variables...', 'info');
            testGlobalVariables(edition);
            
            // Test 2: Check modules
            log('üì¶ Testing Modules...', 'info');
            testModules(edition);
            
            // Test 3: Check data
            log('üìä Testing Data Loading...', 'info');
            await testDataLoading(edition);
            
            // Test 4: Test features
            log('‚ö° Testing Features...', 'info');
            testFeatures(edition);
            
            // Final summary
            log(`\nüéØ FINAL RESULTS: ${testResults.passed}/${testResults.total} tests passed`, 
                testResults.failed === 0 ? 'success' : 'warning');
            
            updateProgress();
        }
        
        function testGlobalVariables(edition) {
            const variables = [
                { name: 'window.poems', obj: edition.poems },
                { name: 'window.teiDoc', obj: edition.teiDoc },
                { name: 'window.persons', obj: edition.persons },
                { name: 'window.pageMapping', obj: edition.pageMapping }
            ];
            
            let moduleHtml = '';
            variables.forEach(v => {
                testResults.total++;
                if (v.obj) {
                    testResults.passed++;
                    log(`‚úÖ ${v.name} is accessible`, 'success');
                    moduleHtml += createTestItem(v.name, true);
                    
                    // Update counts
                    if (v.name === 'window.poems' && Array.isArray(v.obj)) {
                        document.getElementById('poemCount').textContent = v.obj.length;
                    }
                } else {
                    testResults.failed++;
                    log(`‚ùå ${v.name} is not accessible`, 'error');
                    moduleHtml += createTestItem(v.name, false);
                }
            });
            
            document.getElementById('moduleTests').innerHTML = moduleHtml;
        }
        
        function testModules(edition) {
            const modules = [
                'prosopography',
                'metrics',
                'commentary',
                'translation',
                'exportModule',
                'editMode'
            ];
            
            modules.forEach(module => {
                testResults.total++;
                if (edition[module]) {
                    testResults.passed++;
                    log(`‚úÖ ${module} module loaded`, 'success');
                    
                    // Get stats
                    if (module === 'prosopography' && edition[module].persons) {
                        document.getElementById('personCount').textContent = 
                            edition[module].persons.size;
                        document.getElementById('placeCount').textContent = 
                            edition[module].places?.size || 0;
                    }
                    if (module === 'commentary' && edition[module].notes) {
                        document.getElementById('noteCount').textContent = 
                            edition[module].notes.size;
                    }
                    if (module === 'translation' && edition[module].translations) {
                        document.getElementById('translationCount').textContent = 
                            edition[module].translations.size;
                    }
                } else {
                    testResults.failed++;
                    log(`‚ùå ${module} module not loaded`, 'error');
                }
            });
        }
        
        async function testDataLoading(edition) {
            // Test if poems are loaded
            if (edition.poems && edition.poems.length > 0) {
                testResults.total++;
                testResults.passed++;
                log(`‚úÖ ${edition.poems.length} poems loaded`, 'success');
            } else {
                testResults.total++;
                testResults.failed++;
                log(`‚ùå No poems loaded`, 'error');
            }
            
            // Test TEI document
            if (edition.teiDoc) {
                testResults.total++;
                testResults.passed++;
                log(`‚úÖ TEI document loaded`, 'success');
            } else {
                testResults.total++;
                testResults.failed++;
                log(`‚ùå TEI document not loaded`, 'error');
            }
        }
        
        function testFeatures(edition) {
            const featureTests = [];
            
            // Test export functionality
            if (edition.exportAPI) {
                testResults.total++;
                try {
                    const citation = edition.exportAPI.generateCitation('mla');
                    if (citation && citation.length > 0) {
                        testResults.passed++;
                        log(`‚úÖ Export citation generation works`, 'success');
                        featureTests.push(createTestItem('Citation Generation', true));
                    } else {
                        throw new Error('Empty citation');
                    }
                } catch (e) {
                    testResults.failed++;
                    log(`‚ùå Export citation generation failed: ${e.message}`, 'error');
                    featureTests.push(createTestItem('Citation Generation', false));
                }
            }
            
            // Test metrics toggle
            if (edition.metricsAPI) {
                testResults.total++;
                try {
                    const before = edition.metrics.enabled;
                    edition.metricsAPI.toggle();
                    const after = edition.metrics.enabled;
                    if (before !== after) {
                        testResults.passed++;
                        log(`‚úÖ Metrics toggle works`, 'success');
                        featureTests.push(createTestItem('Metrics Toggle', true));
                        // Toggle back
                        edition.metricsAPI.toggle();
                    } else {
                        throw new Error('Toggle did not change state');
                    }
                } catch (e) {
                    testResults.failed++;
                    log(`‚ùå Metrics toggle failed: ${e.message}`, 'error');
                    featureTests.push(createTestItem('Metrics Toggle', false));
                }
            }
            
            document.getElementById('featureTests').innerHTML = featureTests.join('');
        }
        
        async function testExport() {
            log('üì• Testing Export Functionality...', 'info');
            
            const edition = document.getElementById('editionFrame').contentWindow;
            
            if (!edition.poems || edition.poems.length === 0) {
                log('‚ùå Cannot test export - no poems loaded', 'error');
                document.getElementById('exportTests').innerHTML = 
                    createTestItem('Export Test', false, 'No poems available');
                return;
            }
            
            log(`‚úÖ Found ${edition.poems.length} poems to export`, 'success');
            
            // Test different export scenarios
            const exportTests = [];
            
            // Test 1: Export first poem
            const firstPoem = edition.poems[0];
            if (firstPoem) {
                log(`üìÑ First poem: ${firstPoem.id} - ${firstPoem.title}`, 'info');
                log(`   Lines: ${firstPoem.lines?.length || 0}`, 'info');
                exportTests.push(createTestItem('First Poem Data', true, 
                    `${firstPoem.lines?.length || 0} lines`));
            }
            
            // Test 2: Check export formats
            if (edition.exportModule) {
                const formats = edition.exportModule.formats;
                log(`üìã Available formats: ${formats.join(', ')}`, 'info');
                exportTests.push(createTestItem('Export Formats', true, 
                    `${formats.length} formats`));
            }
            
            // Test 3: Generate sample citation
            if (edition.exportAPI) {
                const citation = edition.exportAPI.generateCitation('mla');
                log(`üìñ Sample citation: ${citation.substring(0, 100)}...`, 'info');
                exportTests.push(createTestItem('Citation Generation', true, 'MLA format'));
            }
            
            document.getElementById('exportTests').innerHTML = exportTests.join('');
        }
        
        function createTestItem(name, passed, details = '') {
            const icon = passed ? '‚úÖ' : '‚ùå';
            const resultClass = passed ? 'success' : 'error';
            const detailsText = details ? ` (${details})` : '';
            
            return `
                <div class="test-item">
                    <div class="test-icon">${icon}</div>
                    <div class="test-name">${name}${detailsText}</div>
                    <div class="test-result ${resultClass}">${passed ? 'PASS' : 'FAIL'}</div>
                </div>
            `;
        }
        
        // Auto-run basic check on load
        window.addEventListener('DOMContentLoaded', () => {
            log('üéØ Final Validation Suite Ready', 'info');
            log('Click "Run Full Validation" to begin comprehensive testing', 'info');
        });
    </script>
</body>
</html>